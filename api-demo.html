
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pedena Game API Demo - Simplified</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1a1a1a;
            color: #e0e0e0;
        }
        .section {
            background: #2d2d2d;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #444;
        }
        .section h3 {
            margin-top: 0;
            color: #ffcc00;
            border-bottom: 2px solid #ffcc00;
            padding-bottom: 5px;
        }
        .controls {
            margin-bottom: 15px;
        }
        .controls input, .controls select, .controls textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #555;
            border-radius: 4px;
            background: #333;
            color: #e0e0e0;
            box-sizing: border-box;
        }
        .controls button {
            background: #ffcc00;
            color: #000;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px 5px 5px 0;
            font-weight: bold;
        }
        .controls button:hover {
            background: #ffdd33;
        }
        .output {
            background: #1a1a1a;
            border: 1px solid #555;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            min-height: 100px;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .status-line {
            background: #333;
            padding: 8px;
            margin: 5px 0;
            border-radius: 4px;
            border-left: 3px solid #ffcc00;
        }
    </style>
</head>
<body>
    <h1>üè∞ Pedena Game API Demo - Simplified</h1>
    <p>Character creation, command execution, and localStorage data display with Gemini integration.</p>

    <!-- Character Creation -->
    <div class="section">
        <h3>üë§ Character Creation</h3>
        <div class="controls">
            <input type="text" id="char-name" placeholder="Character Name" value="TestHero">
            <select id="char-class">
                <option value="warrior">Warrior</option>
                <option value="mage">Mage</option>
                <option value="rogue">Rogue</option>
                <option value="ranger">Ranger</option>
            </select>
            <select id="char-gender">
                <option value="male">Male</option>
                <option value="female">Female</option>
            </select>
            <button onclick="createCharacter()">Create Character</button>
            <button onclick="setupGeminiAPI()">Setup Gemini API</button>
        </div>
        <div id="character-output" class="output"></div>
    </div>

    <!-- Command Execution -->
    <div class="section">
        <h3>üéÆ Execute Command</h3>
        <div class="controls">
            <textarea id="command-input" placeholder="Enter your command (e.g., 'explore the area', 'attack the goblin', 'check inventory')" rows="3">explore the ancient ruins</textarea>
            <button onclick="executeCommand()">Execute Command</button>
            <button onclick="quickCommand('rest and recover')">Rest</button>
            <button onclick="quickCommand('explore the area')">Explore</button>
            <button onclick="quickCommand('check inventory')">Inventory</button>
        </div>
        <div id="game-output" class="output"></div>
    </div>

    <!-- Game Data Display -->
    <div class="grid">
        <div class="section">
            <h3>üìä Player Data</h3>
            <button onclick="updatePlayerData()">Refresh Player Data</button>
            <div id="player-data" class="output"></div>
        </div>

        <div class="section">
            <h3>üíæ LocalStorage Data</h3>
            <button onclick="updateLocalStorageData()">Refresh Storage Data</button>
            <div id="storage-data" class="output"></div>
        </div>
    </div>

    <script type="module">
        // Gemini API Configuration
        const GEMINI_API_KEY = 'AIzaSyDIFeql6HUpkZ8JJlr_kuN0WDFHUyOhijA';
        let gameAPI;

        // Simple player object
        let player = {
            name: '',
            class: '',
            gender: '',
            level: 1,
            hp: 100,
            maxHp: 100,
            gold: 50,
            exp: 0,
            expToNextLevel: 100,
            currentLocation: 'Pedena Town Square',
            inventory: [],
            quests: [],
            stats: {
                strength: 10,
                dexterity: 10,
                intelligence: 10,
                constitution: 10,
                wisdom: 10,
                charisma: 10
            },
            equipment: {
                head: null,
                chest: null,
                hands: null,
                legs: null,
                feet: null,
                mainHand: null,
                offHand: null
            }
        };

        // Gemini API Function
        async function callGeminiAPI(prompt, temperature = 0.7, maxTokens = 800) {
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }],
                        generationConfig: {
                            temperature: temperature,
                            maxOutputTokens: maxTokens
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`Gemini API error: ${response.status}`);
                }

                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error('Gemini API error:', error);
                return `Error: ${error.message}`;
            }
        }

        // Setup Gemini API
        window.setupGeminiAPI = async () => {
            try {
                // Test the API
                const testResponse = await callGeminiAPI("Say 'Gemini API connected successfully for Pedena RPG!'");
                document.getElementById('character-output').textContent = `API Test: ${testResponse}`;
                
                // Initialize game API
                const gameAPIModule = await import('./game-api.js');
                gameAPI = gameAPIModule.default;
                await gameAPI.initialize(callGeminiAPI);
                
                window.gameAPI = gameAPI;
                window.callGeminiAPI = callGeminiAPI;
                
                document.getElementById('character-output').textContent += '\n\nGame API initialized with Gemini!';
            } catch (error) {
                document.getElementById('character-output').textContent = `Setup Error: ${error.message}`;
            }
        };

        // Create Character
        window.createCharacter = () => {
            const name = document.getElementById('char-name').value;
            const charClass = document.getElementById('char-class').value;
            const gender = document.getElementById('char-gender').value;

            if (!name.trim()) {
                document.getElementById('character-output').textContent = 'Please enter a character name';
                return;
            }

            // Update player object
            player.name = name;
            player.class = charClass;
            player.gender = gender;
            player.background = `A brave ${charClass} seeking adventure.`;

            // Apply class bonuses
            const classBonuses = {
                warrior: { hp: 20, strength: 3, constitution: 2 },
                mage: { hp: 5, intelligence: 3, wisdom: 2 },
                rogue: { hp: 10, dexterity: 3, intelligence: 2 },
                ranger: { hp: 15, dexterity: 3, wisdom: 2 }
            };

            const bonus = classBonuses[charClass];
            if (bonus) {
                player.maxHp += bonus.hp;
                player.hp = player.maxHp;
                Object.keys(bonus).forEach(stat => {
                    if (stat !== 'hp' && player.stats[stat]) {
                        player.stats[stat] += bonus[stat];
                    }
                });
            }

            // Save to localStorage
            localStorage.setItem('pedena_player', JSON.stringify(player));
            
            // Create character via API if available
            if (gameAPI) {
                const result = gameAPI.createCharacter({
                    name: name,
                    charClass: charClass,
                    gender: gender,
                    background: player.background
                });
                document.getElementById('character-output').textContent = JSON.stringify(result, null, 2);
            } else {
                document.getElementById('character-output').textContent = JSON.stringify({
                    success: true,
                    message: `Character ${name} created successfully`,
                    player: player
                }, null, 2);
            }

            updatePlayerData();
            updateLocalStorageData();
        };

        // Execute Command
        window.executeCommand = async () => {
            const command = document.getElementById('command-input').value;
            if (!command.trim()) return;

            document.getElementById('game-output').textContent = 'Processing command...';

            try {
                let response;
                
                if (gameAPI && gameAPI.aiFunction) {
                    // Use game API
                    const result = await gameAPI.processCommand(command);
                    response = result.response || 'Command processed';
                    
                    // Update player data if changed
                    const newPlayerData = gameAPI.getPlayerData();
                    if (newPlayerData) {
                        player = { ...player, ...newPlayerData };
                        localStorage.setItem('pedena_player', JSON.stringify(player));
                    }
                } else {
                    // Direct Gemini call
                    const gamePrompt = `
You are the Game Master for a fantasy RPG. The player "${player.name}" (Level ${player.level} ${player.class}) is in "${player.currentLocation}".

Player Stats:
- HP: ${player.hp}/${player.maxHp}
- Gold: ${player.gold}
- Location: ${player.currentLocation}

Command: "${command}"

Respond as the Game Master describing what happens. Keep it engaging and under 200 words.
If the action involves:
- Combat: Describe the fight and outcome
- Exploration: Describe discoveries
- Movement: Describe the journey
- Rest: Restore some HP
- Shopping: Show available items

Response:`;

                    response = await callGeminiAPI(gamePrompt);
                    
                    // Simple state updates based on response
                    if (command.toLowerCase().includes('rest')) {
                        const healing = Math.floor(player.maxHp * 0.25);
                        player.hp = Math.min(player.maxHp, player.hp + healing);
                    }
                    
                    if (response.includes('gold') || response.includes('coins')) {
                        const goldMatch = response.match(/(\d+)\s*gold/i);
                        if (goldMatch) {
                            player.gold += parseInt(goldMatch[1]);
                        }
                    }
                    
                    localStorage.setItem('pedena_player', JSON.stringify(player));
                }

                document.getElementById('game-output').textContent = response;
                updatePlayerData();
                updateLocalStorageData();

            } catch (error) {
                document.getElementById('game-output').textContent = `Error: ${error.message}`;
            }
        };

        // Quick Command
        window.quickCommand = async (command) => {
            document.getElementById('command-input').value = command;
            await executeCommand();
        };

        // Update Player Data Display
        window.updatePlayerData = () => {
            // Load latest from localStorage
            const savedPlayer = localStorage.getItem('pedena_player');
            if (savedPlayer) {
                player = JSON.parse(savedPlayer);
            }

            const playerDisplay = `Name: ${player.name || 'None'}
Class: ${player.class || 'None'}
Gender: ${player.gender || 'None'}
Level: ${player.level}
HP: ${player.hp}/${player.maxHp}
Gold: ${player.gold}
XP: ${player.exp}/${player.expToNextLevel}
Location: ${player.currentLocation}

Stats:
- Strength: ${player.stats.strength}
- Dexterity: ${player.stats.dexterity}
- Intelligence: ${player.stats.intelligence}
- Constitution: ${player.stats.constitution}
- Wisdom: ${player.stats.wisdom}
- Charisma: ${player.stats.charisma}

Inventory: ${player.inventory.length} items
Quests: ${player.quests.length} active`;

            document.getElementById('player-data').textContent = playerDisplay;
        };

        // Update LocalStorage Data Display
        window.updateLocalStorageData = () => {
            const storageData = {};
            
            // Get all localStorage keys and their data
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                try {
                    const value = localStorage.getItem(key);
                    storageData[key] = JSON.parse(value);
                } catch {
                    storageData[key] = value;
                }
            }

            document.getElementById('storage-data').textContent = JSON.stringify(storageData, null, 2);
        };

        // Initialize on load
        window.addEventListener('load', () => {
            updatePlayerData();
            updateLocalStorageData();
            setupGeminiAPI();
        });

        // Handle Enter key in command input
        document.addEventListener('DOMContentLoaded', () => {
            const commandInput = document.getElementById('command-input');
            if (commandInput) {
                commandInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        executeCommand();
                    }
                });
            }
        });
    </script>
</body>
</html>
