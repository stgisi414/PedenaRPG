
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pedena Game API Demo - Simple</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1a1a1a;
            color: #e0e0e0;
        }
        .section {
            background: #2d2d2d;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #444;
        }
        .section h3 {
            margin-top: 0;
            color: #ffcc00;
            border-bottom: 2px solid #ffcc00;
            padding-bottom: 5px;
        }
        .controls {
            margin-bottom: 15px;
        }
        .controls input, .controls select, .controls textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #555;
            border-radius: 4px;
            background: #333;
            color: #e0e0e0;
            box-sizing: border-box;
        }
        .controls button {
            background: #ffcc00;
            color: #000;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px 5px 5px 0;
            font-weight: bold;
        }
        .controls button:hover {
            background: #ffdd33;
        }
        .output {
            background: #1a1a1a;
            border: 1px solid #555;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            min-height: 100px;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .status-indicator {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-connected {
            background: #28a745;
            color: white;
        }
        .status-disconnected {
            background: #dc3545;
            color: white;
        }
    </style>
</head>
<body>
    <h1>üè∞ Pedena Game API Demo</h1>
    <p>Simple interface for character creation, command execution, and game data display.</p>
    <div class="status-indicator" id="api-status">üî¥ API Not Connected</div>

    <!-- Character Creation -->
    <div class="section">
        <h3>üë§ Character Creation</h3>
        <div class="controls">
            <input type="text" id="char-name" placeholder="Character Name" value="Hero">
            <select id="char-class">
                <option value="warrior">Warrior</option>
                <option value="mage">Mage</option>
                <option value="rogue">Rogue</option>
                <option value="ranger">Ranger</option>
            </select>
            <select id="char-gender">
                <option value="male">Male</option>
                <option value="female">Female</option>
            </select>
            <button onclick="createCharacter()">Create Character</button>
            <button onclick="initializeAPI()">Initialize API & Gemini</button>
        </div>
        <div id="character-output" class="output">API not initialized. Click 'Initialize API & Gemini' first.</div>
    </div>

    <!-- Command Execution -->
    <div class="section">
        <h3>üéÆ Execute Command</h3>
        <div class="controls">
            <textarea id="command-input" placeholder="Enter your command (e.g., 'explore the area', 'check inventory', 'attack goblin')" rows="3">explore the ancient ruins</textarea>
            <button onclick="executeCommand()">Execute Command</button>
            <button onclick="quickCommand('rest and recover')">Rest</button>
            <button onclick="quickCommand('explore the area')">Explore</button>
            <button onclick="quickCommand('check my stats')">Check Stats</button>
        </div>
        <div id="game-output" class="output">No commands executed yet. Create a character and try a command!</div>
    </div>

    <!-- Game Data Display -->
    <div class="grid">
        <div class="section">
            <h3>üìä Current Game Data</h3>
            <button onclick="refreshGameData()">Refresh Game Data</button>
            <div id="game-data" class="output">No game data available yet.</div>
        </div>

        <div class="section">
            <h3>üíæ LocalStorage Game Data</h3>
            <button onclick="refreshStorageData()">Refresh Storage Data</button>
            <button onclick="clearStorage()">Clear All Storage</button>
            <div id="storage-data" class="output">No storage data loaded yet.</div>
        </div>
    </div>

    <script type="module">
        // Configuration
        const GEMINI_API_KEY = 'AIzaSyDIFeql6HUpkZ8JJlr_kuN0WDFHUyOhijA';
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;

        // Global variables
        let gameAPI = null;
        let player = null;
        let isAPIInitialized = false;

        // Update status indicator
        function updateStatus(connected, message = '') {
            const statusEl = document.getElementById('api-status');
            if (connected) {
                statusEl.className = 'status-indicator status-connected';
                statusEl.textContent = 'üü¢ API Connected' + (message ? ` - ${message}` : '');
            } else {
                statusEl.className = 'status-indicator status-disconnected';
                statusEl.textContent = 'üî¥ API Disconnected' + (message ? ` - ${message}` : '');
            }
        }

        // Gemini API call function
        async function callGeminiAPI(prompt, temperature = 0.7, maxTokens = 800) {
            try {
                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }],
                        generationConfig: {
                            temperature: temperature,
                            maxOutputTokens: maxTokens,
                            topP: 0.8,
                            topK: 40
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`Gemini API error: ${response.status} - ${response.statusText}`);
                }

                const data = await response.json();
                if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                    return data.candidates[0].content.parts[0].text;
                } else {
                    throw new Error('Invalid response format from Gemini API');
                }
            } catch (error) {
                console.error('Gemini API error:', error);
                throw new Error(`Gemini API failed: ${error.message}`);
            }
        }

        // Initialize API and connect to Gemini
        window.initializeAPI = async () => {
            try {
                document.getElementById('character-output').textContent = 'Initializing API and testing Gemini connection...';
                
                // Test Gemini connection
                const testResponse = await callGeminiAPI("Say 'Gemini API connected successfully for Pedena RPG!' and nothing else.");
                
                // Import and initialize game API
                const gameAPIModule = await import('./game-api.js');
                gameAPI = gameAPIModule.default;
                
                const initResult = await gameAPI.initialize(callGeminiAPI);
                
                if (initResult.success) {
                    isAPIInitialized = true;
                    updateStatus(true, 'Gemini Connected');
                    document.getElementById('character-output').textContent = 
                        `‚úÖ API Initialized Successfully!\n` +
                        `Version: ${initResult.version}\n` +
                        `Gemini Test: ${testResponse}\n` +
                        `Ready for character creation and commands.`;
                    
                    // Load existing game data if any
                    refreshGameData();
                    refreshStorageData();
                } else {
                    throw new Error('Failed to initialize game API');
                }
            } catch (error) {
                updateStatus(false, error.message);
                document.getElementById('character-output').textContent = `‚ùå Initialization Failed: ${error.message}`;
                console.error('API initialization error:', error);
            }
        };

        // Create character
        window.createCharacter = async () => {
            if (!isAPIInitialized) {
                document.getElementById('character-output').textContent = '‚ùå Please initialize API first!';
                return;
            }

            try {
                const name = document.getElementById('char-name').value.trim();
                const charClass = document.getElementById('char-class').value;
                const gender = document.getElementById('char-gender').value;

                if (!name) {
                    document.getElementById('character-output').textContent = '‚ùå Please enter a character name';
                    return;
                }

                document.getElementById('character-output').textContent = 'Creating character...';

                const result = gameAPI.createCharacter({
                    name: name,
                    charClass: charClass,
                    gender: gender,
                    background: `A brave ${charClass} seeking adventure in the realm of Pedena.`
                });

                if (result.success) {
                    player = result.player;
                    document.getElementById('character-output').textContent = 
                        `‚úÖ Character Created Successfully!\n\n` +
                        `Name: ${player.name}\n` +
                        `Class: ${player.class}\n` +
                        `Gender: ${player.gender}\n` +
                        `Level: ${player.level}\n` +
                        `HP: ${player.hp}/${player.maxHp}\n` +
                        `Gold: ${player.gold}\n` +
                        `Location: ${player.currentLocation}\n\n` +
                        `Ready to begin adventure!`;
                    
                    refreshGameData();
                    refreshStorageData();
                } else {
                    document.getElementById('character-output').textContent = `‚ùå Character creation failed: ${result.message}`;
                }
            } catch (error) {
                document.getElementById('character-output').textContent = `‚ùå Error creating character: ${error.message}`;
                console.error('Character creation error:', error);
            }
        };

        // Execute command
        window.executeCommand = async () => {
            if (!isAPIInitialized) {
                document.getElementById('game-output').textContent = '‚ùå Please initialize API first!';
                return;
            }

            if (!player) {
                document.getElementById('game-output').textContent = '‚ùå Please create a character first!';
                return;
            }

            try {
                const command = document.getElementById('command-input').value.trim();
                if (!command) {
                    document.getElementById('game-output').textContent = '‚ùå Please enter a command';
                    return;
                }

                document.getElementById('game-output').textContent = `Processing command: "${command}"\n\nPlease wait...`;

                const result = await gameAPI.processCommand(command);

                if (result.success) {
                    const timestamp = new Date().toLocaleTimeString();
                    document.getElementById('game-output').textContent = 
                        `[${timestamp}] Command: "${command}"\n\n` +
                        `${result.response}\n\n` +
                        `Action Type: ${result.actionType || 'general'}\n` +
                        `Confidence: ${result.confidence || 'medium'}\n\n` +
                        `--- Game State Updated ---`;
                    
                    // Update player reference
                    player = result.player;
                    
                    // Refresh displays
                    refreshGameData();
                    refreshStorageData();
                } else {
                    document.getElementById('game-output').textContent = 
                        `‚ùå Command failed: ${result.error || result.message}\n\n` +
                        `Attempted command: "${command}"`;
                }
            } catch (error) {
                document.getElementById('game-output').textContent = 
                    `‚ùå Error executing command: ${error.message}\n\n` +
                    `Command: "${command}"`;
                console.error('Command execution error:', error);
            }
        };

        // Quick command shortcuts
        window.quickCommand = async (command) => {
            document.getElementById('command-input').value = command;
            await executeCommand();
        };

        // Refresh game data display
        window.refreshGameData = () => {
            try {
                if (!gameAPI) {
                    document.getElementById('game-data').textContent = 'Game API not initialized';
                    return;
                }

                const gameState = gameAPI.getGameState();
                const playerData = gameAPI.getPlayerData();
                
                let output = '';
                
                if (playerData) {
                    output += `=== PLAYER DATA ===\n`;
                    output += `Name: ${playerData.name || 'Unknown'}\n`;
                    output += `Class: ${playerData.class || 'Unknown'}\n`;
                    output += `Gender: ${playerData.gender || 'Unknown'}\n`;
                    output += `Level: ${playerData.level || 1}\n`;
                    output += `HP: ${playerData.hp || 0}/${playerData.maxHp || 0}\n`;
                    output += `Gold: ${playerData.gold || 0}\n`;
                    output += `XP: ${playerData.exp || 0}/${playerData.expToNextLevel || 100}\n`;
                    output += `Location: ${playerData.currentLocation || 'Unknown'}\n\n`;
                    
                    output += `=== STATS ===\n`;
                    if (playerData.stats) {
                        Object.entries(playerData.stats).forEach(([stat, value]) => {
                            output += `${stat}: ${value}\n`;
                        });
                    }
                    output += '\n';
                    
                    output += `=== INVENTORY ===\n`;
                    const inventory = playerData.inventory || [];
                    output += `Items: ${inventory.length}\n`;
                    inventory.slice(0, 5).forEach((item, index) => {
                        output += `${index + 1}. ${item.name || 'Unknown Item'}\n`;
                    });
                    if (inventory.length > 5) {
                        output += `... and ${inventory.length - 5} more items\n`;
                    }
                    output += '\n';
                    
                    output += `=== QUESTS ===\n`;
                    const quests = playerData.quests || [];
                    const activeQuests = quests.filter(q => !q.completed);
                    const completedQuests = quests.filter(q => q.completed);
                    output += `Active: ${activeQuests.length}, Completed: ${completedQuests.length}\n`;
                    activeQuests.slice(0, 3).forEach(quest => {
                        output += `‚Ä¢ ${quest.title || 'Untitled Quest'}\n`;
                    });
                    output += '\n';
                    
                    if (playerData.alignmentInfo) {
                        output += `=== ALIGNMENT ===\n`;
                        output += `Type: ${playerData.alignmentInfo.type || 'neutral'}\n`;
                        output += `Score: ${playerData.alignmentInfo.score || 0}\n\n`;
                    }
                } else {
                    output = 'No player data available. Create a character first.';
                }
                
                document.getElementById('game-data').textContent = output;
            } catch (error) {
                document.getElementById('game-data').textContent = `Error loading game data: ${error.message}`;
                console.error('Game data refresh error:', error);
            }
        };

        // Refresh storage data display
        window.refreshStorageData = () => {
            try {
                const storageData = {};
                
                // Get all relevant localStorage keys
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && (key.includes('pedena') || key.includes('game') || key.includes('player'))) {
                        try {
                            const value = localStorage.getItem(key);
                            storageData[key] = JSON.parse(value);
                        } catch {
                            storageData[key] = value; // Keep as string if not JSON
                        }
                    }
                }
                
                let output = `=== LOCALSTORAGE GAME DATA ===\n`;
                output += `Total Keys Found: ${Object.keys(storageData).length}\n\n`;
                
                Object.entries(storageData).forEach(([key, value]) => {
                    output += `[${key}]:\n`;
                    if (typeof value === 'object') {
                        output += JSON.stringify(value, null, 2);
                    } else {
                        output += value;
                    }
                    output += '\n\n';
                });
                
                if (Object.keys(storageData).length === 0) {
                    output += 'No Pedena game data found in localStorage.\nCreate a character and execute commands to generate data.';
                }
                
                document.getElementById('storage-data').textContent = output;
            } catch (error) {
                document.getElementById('storage-data').textContent = `Error loading storage data: ${error.message}`;
                console.error('Storage data refresh error:', error);
            }
        };

        // Clear storage
        window.clearStorage = () => {
            if (confirm('Are you sure you want to clear all game data? This cannot be undone.')) {
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && (key.includes('pedena') || key.includes('game') || key.includes('player'))) {
                        keysToRemove.push(key);
                    }
                }
                
                keysToRemove.forEach(key => localStorage.removeItem(key));
                
                player = null;
                refreshGameData();
                refreshStorageData();
                
                document.getElementById('character-output').textContent = '‚úÖ All game data cleared from localStorage.';
                document.getElementById('game-output').textContent = 'Storage cleared. Create a new character to start fresh.';
            }
        };

        // Handle Enter key in command input
        document.addEventListener('DOMContentLoaded', () => {
            const commandInput = document.getElementById('command-input');
            if (commandInput) {
                commandInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        executeCommand();
                    }
                });
            }
        });

        // Auto-initialize on load
        window.addEventListener('load', () => {
            refreshStorageData();
            // Auto-initialize API
            setTimeout(() => {
                initializeAPI();
            }, 500);
        });
    </script>
</body>
</html>
